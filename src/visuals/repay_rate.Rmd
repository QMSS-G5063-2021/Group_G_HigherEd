---
title: "Repay Rate"
author: Arielle Herman
date: 2021-04-04
always_allow_html: yes
output: 
  html_document:
    keep_md: true
    toc: true
---

```{r setup, message=F, warning=F}
library(ggplot2)
library(tidyverse)

filepath <- paste0(stringr::str_remove(getwd(),"visuals"), "data/sc_repay.Rdata")
if(file.exists(filepath)) {
  load("../data/sc_repay.Rdata")
} else {
  sc_repay <- educationdata::get_education_data(level = 'college-university', source = 'scorecard',
                                              topic = 'repayment', filters = list(year = 2007:2016),
                                              add_labels = TRUE)
  save(sc_repay, file = "../data/sc_repay.Rdata")
}

scorecard <- readr::read_csv("../data/2019_College_Scorecard_Valid_Admissions_Data.csv")
```

# steps
1. list out independent variables (cohort year, year,)
2. which independent variable do I need to sum over to get 1 if I included the other group

```{r}
scorecard$CDR3
sc_repay
sc_repay %>% group_by(years_since_entering_repay, cohort_year) %>% summarize(n(), sum(repay_rate))
sc_repay %>% filter(year < cohort_year)
sc_repay
scorecard
```

```{r repay_rate, message=F, warning=F}
#selective_schools <- na.omit(scorecard$OPEID[scorecard$ADM_RATE < 0.3])
#question: select for nonprofit and private schools?
# fraction of repayment cohort that is not currently in default

sc_repay %>%
  
  #filter(years_since_entering_repay <= 1) %>%
  pivot_longer(cols = c("repay_rate_lowincome", "repay_rate_midincome", "repay_rate_highincome"),
               names_to = "class", values_to = "rates") %>%
  filter(rates > 0) %>%
  ggplot(aes(x = year, y = rates, group = cohort_year, fill = class)) + geom_violin(color = "lightgray") +
  #facet_grid(cohort_year ~ .) +
  facet_grid(. ~ factor(class, levels =
                          c("repay_rate_highincome", "repay_rate_midincome", "repay_rate_lowincome")),
             scales = "free", space = "free") +
  ggthemes::theme_tufte() +
  # who are not in default, and with loan balances that have declined
  ggtitle("Fraction Of Students In Fiscal Cohorts Whose Loan Balances\nHave Declined One Year After Entering Repayment") +
  xlab(NULL) + ylab(NULL) +
  scale_fill_viridis_d(name = "Income Range:", labels = c("High Income", "Middle Income", "Low Income")) + #geom_smooth(aes(group = cohort_year), method = "lm") +
  theme(#panel.border = element_rect(color = "lightgray"),
    #panel.spacing = unit(1, "cm"),
    #panel.grid.minor = element_line(colour = "grey"),
    legend.position = "bottom",
    plot.title = element_text(hjust=0.5),
        strip.text.x = element_blank())

sc_repay %>%
  filter(repay_rate > 0, years_since_entering_repay == 1) %>%
  group_by(cohort_year, year, years_since_entering_repay) %>%
  summarize_if(is.numeric, median) %>% select(contains("year"), contains("rate")) %>%
  pivot_longer(cols = c("repay_rate_lowincome", "repay_rate_midincome", "repay_rate_highincome", "repay_rate"),
               names_to = "class", values_to = "median_rates") %>%
  mutate(total = class == "repay_rate",
         class = factor(class, c("repay_rate", "repay_rate_highincome", "repay_rate_midincome", "repay_rate_lowincome"))) %>%
  
  ggplot(aes(x = cohort_year, y = median_rates, group = class, color = class)) + geom_line() + geom_point() +
  facet_wrap(. ~ factor(total, c(TRUE, FALSE))) +
  ggtitle("Fraction of Students in a Fiscal Cohort Whose Loan Balances\nHave Declined One Year After Entering Repayment") +
  xlab("Cohort Year") + ylab("Median Fraction of Fiscal Cohort") +
  #scale_color_discrete() +
  scale_color_viridis_d(name = "Median Fraction\nof Cohort", labels = c("Overall", "High Income", "Middle Income", "Low Income")) + ggthemes::theme_tufte() +
  theme(panel.background = element_rect(fill = "lightgray", color = "lightgray"),
        strip.text.x = element_blank())
```
